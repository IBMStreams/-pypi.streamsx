/* Additional includes go here */

#include "splpy.h"
#include "splpy_funcop.h"

using namespace streamsx::topology;

<%SPL::CodeGen::implementationPrologue($model);%>

@include "../pyspltuple.cgt"

// Constructor
MY_OPERATOR::MY_OPERATOR() :
   funcop_(NULL),
   function_(NULL)
{
    funcop_ = new SplpyFuncOp(this);

    SplpyGILLock lock;

    PyObject *_module_;
    PyObject *_function_;

<%
 # Select the Python wrapper function
 my $pywrapfunc= $pystyle . '_in';
%>
@include "../pywrapfunction.cgt"
}


// Destructor
MY_OPERATOR::~MY_OPERATOR() 
{
    // Finalization code goes here
    if (function_) {
      SplpyGILLock lock;
      Py_DECREF(function_);
    }

    delete funcop_;
}

// Notify pending shutdown
void MY_OPERATOR::prepareToShutdown() 
{
    SplpyOp::prepareToShutdown();
}

// Tuple processing for non-mutating ports
void MY_OPERATOR::process(Tuple const & tuple, uint32_t port)
{
  IPort0Type const &ip = static_cast<IPort0Type const &>(tuple);

<%
print splpy_inputtuple2value($pystyle);
%>

<%if ($pystyle eq 'dict') {%>
@include "../pyspltuple2dict.cgt"
  SPL::int32 spl_hash = streamsx::topology::Splpy::pyTupleHash(function_, value);
  OPort0Type oTemptuple; //  (ip, spl_hash);
  oTemptuple.assignFrom(tuple, false);
  OPort0Type otuple(oTemptuple, spl_hash); //  (ip, spl_hash);

<%}%>
<%if ($pystyle ne 'dict') {%>
  SPL::int32 spl_hash = streamsx::topology::Splpy::pyTupleHash(function_, value);

  OPort0Type otuple(value, spl_hash);
<%}%>
  // submit tuple
  submit(otuple, 0);
}

<%SPL::CodeGen::implementationEpilogue($model);%>
